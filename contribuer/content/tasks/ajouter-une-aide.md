---
title: ğŸ›  Ajouter une aide
duration: 90
prerequisites:
  - ajouter-une-institution
---

L'objectif de cette contribution est d'ajouter une premiÃ¨re aide dans le simulateur.

Il s'agira d'une version simplifiÃ©e par rapport Ã  la rÃ©alitÃ© mais qui constituera dÃ©jÃ  une premiÃ¨re Ã©tape. La complexitÃ© de cette aide sera intÃ©grÃ©e et mise en compte progressivement.


## Choisir une aide - 5 minutes grand max

Il va falloir dÃ©terminer l'aide que vous souhaitez intÃ©ger. Pour une premiÃ¨re aide, il faut essayer d'en choissir une **simple**, pour laquelle vous avez Ã  votre disposition des **documents de rÃ©fÃ©rence** (rÃ©glement intÃ©rieur, annexes de dÃ©libÃ©ration, etc) dans lesquels sont dÃ©taillÃ©es les rÃ¨gles permettant de la calculer. Enfin, il faut aussi que les **ressources** permettant aux usagers des **faire les dÃ©marches** soient **accessibles** (page d'information, formulaire en ligne, tÃ©lÃ©service, etc).

![SchÃ©ma des Ã©tapes entre la contribution et le bÃ©nÃ©fice de l'aide](/img/ajouter-une-aide/schema.svg)

Dans un premier temps, nous allons indiquer aux usagers que l'Ã©ligibilitÃ© Ã  cette aide. Si un montant peut Ãªtre calculÃ© (forfaitaire ou en fonction du foyer) il le sera plus tard. En effet de tels calculs augmentent la complexitÃ© et cette contribution n'en serait que plus difficile.


## Lister les critÃ¨res - 5 minutes max

Les documents de rÃ©fÃ©rence Ã©tant prÃ©cis mais difficiles Ã  comprendre par le plus grand nombre, la rÃ©daction d'une liste de critÃ¨re est un premier travail de simplification. 

Il s'agit de remplir le paragraphe suivant :

Pour bÃ©nÃ©ficier de l'aide, il faut :
- ... **et**
- ... **et**
- ... **et**
- ... **et**

VoilÃ  quelques exemples de critÃ¨res :
- RÃ©sider dans la ville de CanÃ©jan
- RÃ©sider dans le dÃ©partement du Bas-Rhin
- ÃŠtre agÃ© de plus de 65 ans
- ÃŠtre bÃ©nÃ©ficiaire du RSA
- ÃŠtre parent isolÃ©
- Avoir un taux d'incapacitÃ© supÃ©rieur Ã  80%
- Avoir des ressources mensuelles infÃ©rieures au SMIC

Il arrive que certains critÃ¨res soient plus complexes, _Ãªtre Ã¢gÃ© de plus de 65 ans ou de plus de 60 avec un taux d'incapacitÃ© de plus de 50%_ en est un exemple.

Il arrive aussi que des critÃ¨res puissent Ãªtre regroupÃ©s en un critÃ¨re moins prÃ©cis mais qui Ã©vite de faire une longue Ã©numÃ©ration. Par exemple, _Avoir signÃ© un CDD de plus de 3 mois ou un CDI ou Ãªtre entrÃ©e dans une formation de plus de 6 mois_ peut Ãªtre rÃ©sumÃ©e par _Avoir repris une activitÃ©_.

Cette liste sera un point de dÃ©part pour coder les rÃ¨gles de votre aide dans le moteur de calculs.


## Renseigner les informations relatives Ã  l'aide - 5 minutes max

En vous connectant Ã  <a href="https://contribuer.mes-aides.org/admin/#/collections/benefits/new" target="_blank" rel="noopener">l'outil de contribution</a>, vous pouvez ajouter les informations de votre aide. Les informations receuillies jusqu'Ã  prÃ©sent vont faciliter la saisie des informations demandÃ©es.

La liste des critÃ¨res tout juste Ã©tablies devra Ãªtre saisie dans Â« Conditions non prises ne comptent par le simulateur Â» en ajoutant les critÃ¨res un par un Ã  partir du bouton Â« add condition non prise ne comptent par le simulateur Â».

Une fois les informations saisies, il faut les Â« Enregistrer Â» Ã  partir du bouton en haut Ã  gauche.

Avec cet enregistrement, une version de dÃ©monstration va Ãªtre mise Ã  disposition pour vous permettre de constater la prÃ©sence de votre aide. Comme cela prend quelques minutes, vous pouvez continuer et nous y reviendrons plus tart. TODO vÃ©rifier si un email est envoyÃ© automatiquement au nouveau commentaire de Netlify.


## PrÃ©parer l'environnement de travail - 10 minutes max

Avec cette contribution, vous allez mettre les mains dans le camboui. Plus prÃ©cisÃ©ment, vous allez Ã©crire de premiÃ¨res rÃ¨gles dans un moteur de calculs. Le moteur de calculs que nous utilisons s'appelle OpenFisca. Pour vous faciliter la tÃ¢che, nous avons indiquÃ© comment obtenir un environnement de travail en quelques minutes.


### Se crÃ©er un compte sur GitHub - 3 minutes max

GitHub est une plateforme qui facilite la collaboration autour du code source ouvert comme c'est le cas pour le code de Mes Aides.

Lorsque des produits, services en ligne sont dÃ©veloppÃ©s de faÃ§on ouverte, de nombreux outils facilitant la collaboration sont mis Ã  disposition gratuitement.

Nous vous conseillons de vous crÃ©er un compte **personnel**, en effet, l'activitÃ© d'un compte GitHub est Ã   valoriser pour les personnes qui travaillent dans le numÃ©rique.

Pour vous inscrire, c'est [ici](https://github.com/join).

- Username/Email/Mot de passe
- Â« Verifier Â» pour valider que vous n'Ãªtes pas un robot
- Â« Join a free plan Â»
- Validez votre email Ã  partir du lien dans l'email que vous avez reÃ§u
- Â« Skip this for now Â»

Vous devriez arriver sur une page qui ressemble Ã  Ã§a :

![Page d'accueil de GitHub](/img/ajouter-une-aide/github.png)


### Lancer un environnement de travail en ligne - 4 minutes max

Avec ce compte, vous allez pouvoir avoir un environnement de travail fonctionnel en quelques minutes en utilisant GitPod.

GitPod est un service en ligne qui permet de crÃ©er un tel environnement dans votre navigateur sans avoir besoin d'installer quoi que ce soit. Ce n'est pas une solution pour le long terme mais c'est extrÃªmement pratique lorsque l'on souhaite expÃ©rimenter.

Pour crÃ©er votre environnement de travail, c'est [par ici][https://gitpod.io/#https://github.com/mes-aides/openfisca-france-local).

- Â« Login with GitHub and start coding Â»
- Â« Authorize gitpod-io Â»
- Cochez Â« I agree to the terms of service Â» et validez

AprÃ¨s quelques secondes d'installation, vous devriez arriver sur l'interface suivante :

![Interface de GitPod](/img/ajouter-une-aide/gitpod.png)

Sur cet Ã©cran, nous allons commencer par dÃ©crire les 3 parties les plus importantes :
- sur la gauche (1), il y a l'explorateur de fichiers et de dossiers.
- en centre (2), vous pouvez accÃ©der au contenu des fichiers. Au dÃ©part, le fichier _README_ est ouvert. GÃ©nÃ©ralement ce fichier contient des informations et des instructions pour commencer.
- en bas (3), il y a ce qu'on appelle un terminal. C'est un outil qui permet de communiquer avec l'ordinateur.


### Utiliser le terminal

Pour donner un exemple :
- Cliquez dans la zone en bas (n'importe oÃ¹ dans la zone).
  - Le petit carrÃ© noir va devenir gris pour indiquer que nous sommes bien dans la zone.
- Ã‰crivez Â« date Â», cela devrait aussi s'afficher dans la zone
- Appuyez sur la touche Â« EntrÃ©e Â» de votre clavier.
  - Cela devrait faire apparaÃ®tre, la date et l'heure actuelle (en anglais). Au moment de l'Ã©criture de ce document, cela affiche `Wed 06 May 2020 02:51:06 PM UTC`.

Ã‰crire Â« date Â» dans un terminal et appuyer sur Â« EntrÃ©e Â» est souvent appelÃ© Â« lancer la commande `date` Â» ou encore Â« exÃ©cuter la commande `date` Â».

> Astuce : Si vous n'Ã©crivez que Â« da Â» puis appuyez deux fois sur la touche tabulation (â†¹ Ã  gauche de la lettre A) cela doit faire apparaitre une liste de mots qui sont les commandes que comprend l'ordinateur. En rajoutant un Â« t Â» et en faisant Ã  nouveau Â« tabulation Â», le Â« e Â» est rajoutÃ© automatiquement.

C'est bien de pouvoir demander Ã  l'ordinateur d'afficher la date et l'heure mais ce n'est pas vraiment pour Ã§a que vous Ãªtes lÃ . Continuons.

### VÃ©rifier que votre environnement est fonctionnel - 12 minutes max

Pour cela, vous pouvez lancer la commande `openfisca_local_test tests/test_dispositif.yml`. Vous pouvez copier-coller le texte depuis ce document (en selectionnant le texte avec la souris puis avec votre clavier et les combinaisons Ctrl+C, Ctrl+V).

Cela devrait Ã©crire dans le terminal quelque chose comme Ã§a :

```console
====================== test session starts ======================
platform linux -- Python 3.8.2, pytest-5.4.1, py-1.8.1, pluggy-0.13.1
rootdir: /workspace/openfisca-france-local
plugins: pylama-7.7.1
collected 1 item

tests/test_dispositif.yml .

======================= warnings summary ========================
/workspace/.pip-modules/lib/python3.8/site-packages/openfisca_core/tools/test_runner.py:245
  /workspace/.pip-modules/lib/python3.8/site-packages/openfisca_core/tools/test_runner.py:245: PytestDeprecationWarning: direct construction of YamlFile has been deprecated, please use YamlFile.from_parent
    return YamlFile(path, parent, self.tax_benefit_system, self.options)

/workspace/.pip-modules/lib/python3.8/site-packages/openfisca_core/tools/test_runner.py:102
  /workspace/.pip-modules/lib/python3.8/site-packages/openfisca_core/tools/test_runner.py:102: PytestDeprecationWarning: direct construction of YamlItem has been deprecated, please use YamlItem.from_parent
    yield YamlItem('', self, self.tax_benefit_system, test, self.options)

-- Docs: https://docs.pytest.org/en/latest/warnings.html
================= 2 passed, 2 warnings in 0.02s =================
```

Revenons plus en dÃ©tails sur ce que vous venez de faire.

La commande `openfisca_local_test tests/test_dispositif.yml` s'est terminÃ©e avec un message qui ressemble Ã 
```console
--------------- 2 passed --------------------
```

Cela signifie que 2 deux tests ont Ã©tÃ© exÃ©cutÃ©s avec succÃ¨s.

Les [tests](https://fr.wikipedia.org/wiki/Test_(informatique)) sont trÃ©s utilisÃ©s dans le numÃ©rique. Ils nous permettent de valider le comportement des logiciels. Par exemple, lorsque l'on souhaite valider une opÃ©ration, on associe des valeurs en entrÃ©e avec la valeur attendue en rÃ©sultat.

Par exemple, dans le cas d'une calculatrice on pourrait vÃ©rifier que l'opÃ©ration Â« somme Â» avec le symbole Â« + Â» donne les bons rÃ©sultats. Un exemple de test serait :

- Valeurs en entrÃ©e
  - 1
  - 1
- RÃ©sultat attendu
  - 2

Ce test vÃ©rifie rait que 1 + 1 est bien Ã©gal 2 avec le logiciel de la calculatrice.

Dans le fichier `tests/test_dispositif.yml`, il y a donc deux tests. Vous pouvez utiliser l'explorateur de fichiers de gauche pour accÃ©der Ã  ce fichier. En cliquant sur :
- Â« tests Â» puis
- Â« test_dispositif.yaml Â».

Le contenu du fichier devrait apparaÃ®tre au centre de votre fenÃªtre. Cela devrait ressembler Ã  Ã§a (avec des couleurs diffÃ©rentes) :

```yaml
- period: 2018-01
  input:
    age: 18
  output:
    test_dispositif: true

- period: 2018-01
  input:
    age: 0
  output:
    test_dispositif: false
```

Les deux tirets reprÃ©sentent le dÃ©but de chaque test. Chacun comporte :
- une pÃ©riode
- des valeurs de variables en entrÃ©e `input` et
- des valeurs de variables en sortie `output`.

Dans le premier test, on indique `18` pour la variable `age` (c'est un Ã¢ge en annÃ©e) et **on s'attend en sortie** Ã  ce que la valeur de la variable `test_dispositif` soit Ã©gale Ã  *true* ou *vrai* en franÃ§ais.
Dans le second test, on donne un Ã¢ge de 0 et on s'attend Ã  ce que `test_dispositif` vaut *false* ou *faux* en franÃ§ais.

Maintenant, on va remplacer la valeur de `age` dans le second test par `17`. Il faut enregistrer les modifications en cliquant sur Â« File Â» et Â« Save Â» ou avec le clavier Ctrl+S. Ensuite, lancez Ã  nouveau la commande `openfisca_local_test tests/test_dispositif.yml`.

Cette fois-ci, le rÃ©sultat ne devrait plus afficher `2 passed` mais `1 failed, 1 passed`. En regardant en dÃ©tail, il est indiquÃ© qu'il y a une erreur avec le second test. La valeur **attendue** est _false_ (ou 0) alors que la valeur **obtenue** est _vrai_ (ou 1).

Pour davantage comprendre ce qui se passe regardons un second fichier `openfisca_france_local/test_dispositif.py` (vous pouvez toujours y accÃ©der Ã  partir de l'explorateur de fichier de gauche).

```python
 # -*- coding: utf-8 -*-
from openfisca_france.model.base import Individu, Variable, MONTH


class test_dispositif(Variable):
    value_type = bool
    entity = Individu
    definition_period = MONTH
    label = u"Variable de test pour l'extension"

    def formula(individu, period):
        return individu('age', period) > 0
```

La ligne `class test_dispositif(Variable):` indique la crÃ©ation d'une variable intitulÃ©e `test_dispositif`.

Les deux derniÃ¨res lignes indiquent comment cette variable est calculÃ©e, `individu('age', period) > 0` indique que la valeur sera vraie si l'Ã¢ge est strictement supÃ©rieur Ã  zÃ©ro et faux dans le cas contraire.

Pour permettre au second test que nous avons modifiÃ© d'Ãªtre valide, nous pourrions modifier le calcul de la variable `test_dispositif`. En remplaÃ§ant `return individu('age', period)` par `return individu('age', period) >= 18` par exemple. Dans ce cas-lÃ , on ne s'intÃ©rresse pas Ã  savoir si l'individu est nÃ© (Ã¢ge > 0) mais si cet individu Ã  la majoritÃ© lÃ©gale (Ã¢ge >= 18).

Vous pouvez en faire l'expÃ©rience, en modifiant le fichier, le sauvegardant puis en lanÃ§ant la commande `openfisca_local_test tests/test_dispositif.yml`.

Normalement, le rÃ©sultat finit Ã  nouveau par `----------- 2 passed -------------`.

Cet exercice peut sembler Ãªtre un dÃ©tour par rapport Ã  l'ajout d'une aide mais la comprÃ©hension des tests et de leur intÃ©rÃªt est primordiale.


### Supprimer les modifications apportÃ©es

Ces modifications ne doivent pas Ãªtre conservÃ©es car elles constituaient un premier test pour vous familiariser avec GitPod.

Vous pouvez accÃ©der Ã  la liste des modifications en cliquant sur le symbole en forme de Y sur la gauche (1). Pour toutes les annuler, il faut cliquer sur les trois petits points (2), choisir Â« Discard All Changes Â» (3) et confirmer la suppression avec Â« OK Â».

En suivant ces Ã©tapes vous retrouvez votre environnement comme vous l'avez trouvÃ© au dÃ©part.

![Ã‰tapes pour la suppression des modifications dans GitPod](/img/ajouter-une-aide/gitpod-suppression.png)


## ImplÃ©menter la premiÃ¨re rÃ¨gle - 15 minutes

Maintenant que vous avez un environnement de travail fonctionnel, vous allez pouvoir commencer Ã  coder votre rÃ¨gle.


### Choisir le premier critÃ¨re Ã  prendre en compte

Il va falloir choisir un critÃ¨re dans la liste que vous avez rÃ©digÃ©e prÃ©cÃ©demment. Ã‰tant donnÃ© que c'est une premiÃ¨re, il faut choisir ce qui vous parait le plus facile.

Nous allons dÃ©taillÃ© la suite des Ã©tapes pour 4 critÃ¨res diffÃ©rents (1 seul pour le moment) que vous pourrez adapter Ã  votre situation

1. RÃ©sider dans la ville de AAA
2. ~~ÃŠtre agÃ© de plus de CCC ans~~ (Ã€ dÃ©tailler)
3. ~~ÃŠtre bÃ©nÃ©ficiaire de DDD~~ (Ã€ dÃ©tailler)

Nous allons continuer ce guide en considÃ©rant que nous souhaitons ajouter le Â« [NoÃ«l des enfants](https://www.alfortville.fr/le-pole-solidarite-insertion) Â» mis en place par la ville d'Alfortville. Comme premier critÃ¨re nous allons prendre Â« RÃ©sider dans la ville d'[Alfortville](https://fr.wikipedia.org/wiki/Alfortville) Â».

Si votre critÃ¨re est trÃ¨s diffÃ©rent, faites-nous signe Ã  [accompagnement@mes-aides.org](mailto:accompagnement@mes-aides.org), nous nous ferons un plaisir de complÃ©ter ces informations (on a Ã©tÃ© Ã  l'essentiel).

Le critÃ¨re Â« RÃ©sider dans la ville d'Alfortville Â» est facile Ã  comprendre pour nous humains. Le moteur de calculs ne va pas utiliser  le nom de la ville mais son identifiant INSEE. Cela est prÃ©fÃ©rable car le nom de la ville peut Ãªtre orthographiÃ© de plusieurs faÃ§on (avec le tiret, tout en majuscules, etc.) alors que l'identifiant n'a pas cet inconvÃ©niant. Il est existe plusieurs endroits oÃ¹ le code INSEE peut Ãªtre trouvÃ©. Sur [la page wikipÃ©dia de Alfortville](https://fr.wikipedia.org/wiki/Alfortville) on y apprend que son code commune (oÃ¹ code INSEE) est 94002.

Avant d'aller plus loin, nous avons faire un dernier prÃ©paratif. Il va falloir donner un identifiant Ã  votre aide. En voilÃ  quelques exemples :

- `alfortville_noel_enfants`
- `cotes_d_armor_fonds_solidarite_logement_acces_maintien_plafond`
- `nouvelle_aquitaine_carte_solidaire`


### CrÃ©er un premier fichier de test

Il y a un dossier intitulÃ© `tests` Ã  la racine du dossier principal. En fonction de votre administration, vous pouvez choisir le meilleur sous-dossier&nbsp;:
- communes
- dÃ©partements
- mÃ©tropoles
- rÃ©gions

Vous pouvez regarder les fichiers existants et essayer de reprendre les mÃªmes conventions.

- Bouton-droit sur le dossier dans lequel vous voulez crÃ©er le fichier.
- Indiquer le nom du fichier avec comme extension **`.yaml`** par exemple `mon_aide.yaml`.

Dans le cas que nous utilisons, nous allons crÃ©er le fichier `tests/communes/alfortville/noel_enfants.yaml`.


### DÃ©crire vos premiers tests

Dans l'espace au centre, le fichier encore vide a Ã©tÃ© crÃ©Ã©, vous pouvez y copier le contenu suivant :

```yaml
- period: 2020-05
  input:
    depcom: 94002
  output:
    alfortville_noel_enfants: true
```

`depcom` permet d'indiquer le code INSEE de la commune. Comme annoncÃ© prÃ©cÃ©demment, `94002` est le code commune d'Alfortville. (Depcom : c'est un raccourci pour DÃ©partement/Commune car les deux premiers chiffres reprÃ©sentent le dÃ©partement et les trois derniers la commune au sein du dÃ©partement).

`alfortville_noel_enfants` a Ã©tÃ© utilisÃ© car c'est l'identifiant que nous avons choisi pour le NoÃ«l des enfants mis en place par la ville.

Vous devez ajuster ces valeurs Ã  votre aide.

Avec ce nouveau test, il est possible de lancer la commande `tests/communes/alfortville/noel_enfants.yaml`. Vous devriez obtenir une erreur (`1 failed`) avec un message qui indique :

```console
You tried to calculate or to set a value for variable 'alfortville_noel_enfants', but it was not found in the loaded tax and benefit system (openfisca-france@48.9.5).
```

Cela signifie que la variable `alfortville_noel_enfants` n'existe pas encore. Effectivement, nous ne l'avons pas encore crÃ©Ã©e. Pour cela, il faut crÃ©er un nouveau fichier.

De notre cÃ´tÃ©, nous allons crÃ©er un ficher `openfisca_france_local/communes/alfortville/noel_enfants.py`. Pour commencer nous y copions le contenu suivant :

```python
 # -*- coding: utf-8 -*-
from openfisca_france.model.base import Menage, Variable, MONTH


class alfortville_noel_enfants(Variable):
    value_type = bool
    entity = Menage
    definition_period = MONTH
    label = u"Ã‰ligibilitÃ© au NoÃ«l des enfants d'Alfortville"

    def formula(menage, period):
        return menage('depcom', period) == b'xxxxx'
```

En lanÃ§ant Ã  nouveau la commande `openfisca_local_test openfisca_local_test tests/communes/alfortville/noel_enfants.yaml`, vous devriez encore obtenir une erreur (`1 failed`) avec un message diffÃ©rent.

La derniÃ¨re ligne `return menage('depcom', period) == b'xxxxx'` compare la valeur de `depcom` Ã  `xxxxx`. Dans notre cas, il est nÃ©cessaire de changer `xxxxx` en `94002` pour obtenir `return menage('depcom', period) == b'94002'`.

En relanÃ§ant le test, l'erreur devrait avoir disparu (`1 passed`).

Ce premier test permet de valider qu'un mÃ©nage d'Alfortville apparait Ã©ligible au dispositif.

Ajoutons-en un second pour valider qu'un mÃ©nage hors de cette ville y est effectivement pas Ã©ligible. Dans nos cas, nous ajoutons le test suivant Ã  la suite du fichier `tests/communes/alfortville/noel_enfants.yaml` :

```yaml
- period: 2020-05
  input:
    depcom: 67218
  output:
    alfortville_noel_enfants: false
```

En relanÃ§ant le test (`openfisca_local_test openfisca_local_test tests/communes/alfortville/noel_enfants.yaml`), aucune erreur n'apparait et l'on obtient (`2 passed`).

Vous avez rÃ©digÃ© votre premiÃ¨re rÃ¨gle pour cette nouvelle aide.


## Partager avec nous vos premiers travaux - 5 minutes

Choisir les fichiers Ã  partager

4 quatres devraient Ãªtre affichÃ©s

Ne pas prendre les fichiers

Commit

Push

Ouvrir une pull request

## Modifier les informations sur votre aide - 5 minutes

Normalement, le critÃ¨re que vous avez codÃ© dans le moteur de calculs est prÃ©sent dans la liste rÃ©digÃ©e initialement. Il est dÃ©sormais pris en compte dans le simulateur donc ce critÃ¨re devrait Ãªtre supprimÃ© de la liste des Â« conditions non prises en compte dans le simulateur Â».

Pour cela, vous pouvez accÃ©der Ã  votre contribution Ã  [la page suivante](https://contribuer.mes-aides.org/admin/#/workflow), cliquer sur la carte correspondante, supprimer le critÃ¨re de la liste et enregistrer vos modifications.

## Demander l'ajout de l'aide dans le simulateur (1 minute)

Pour terminer, lorsque vous souhaitez ajouter cette aide au simulateur, vous pouvez nous contacter Ã  [accompagnement@mes-aides.org](mailto:accompagnement@mes-aides.org). Vous pouvez aussi indiquer que votre contribution est prÃªte directement dans l'outil. Pour cela, vous pouvez cliquer en haut Ã  droite sur Â«&nbsp;dÃ©finir le statut&nbsp;Â» et choisir Â«&nbsp;PrÃªt&nbsp;Â» ou bien dÃ©placer [la carte de votre contribution](https://contribuer.mes-aides.org/admin/#/workflow) dans la colonne Â« PrÃªt Â».

<style>{`
img {
  max-width: 100%;
}
`}</style>
